<!DOCTYPE html>
<html lang="en">

<head>
    <title>Kitty Fuzzer Report</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="static/style.css">
</head>

<body>
    <script src="js/jquery-1.11.1.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="static/jquery.js"></script>

    <div class="page-header">
        <h2 id="report_name"></h2>
    </div>

    <table id="reports_container_table" class="table table-main-layout">
        <tbody id="reports_container_table_body">
            <tr><td>
                <div class="panel panel-danger">
                    <div class="panel-heading">Main Report</div>
                    <table id="main_report_table" class="table table-hover table-striped table-bordered info-table">
                        <tr><td>Issuer</td><td id="main_report_name"></td></tr>
                        <tr><td>Status</td><td id="main_report_status"></td></tr>
                        <tr><td>Reason</td><td id="main_report_reason"></td></tr>
                        <tr><td>Fuzz Path</td><td id="main_report_fuzz_path"></td></tr>
                    </table>
                </div>
            </td></tr>
        </tbody>
        
    </table>

    <script>

        /* Change a string to title case: 'hello world'-> 'Hello World' */
        function toTitleCase(str) {
            return str.replace(/_/g, ' ').replace(
                /(\s|^|\/)([a-zA-Z])/g,
                function(txt, a, b) {
                    return a + b.toUpperCase();
                }
            );
        }

        /* Replace "bad" chars with '_' */
        function sanitizeName(str) {
            return str.replace(/\W+/g, '_');
        }

        /* Decode as base64 if the value is a string */
        function kunescape(val) {
            if((typeof val) == 'string') {
                val = window.atob(val);
            }
            return val;
        }

        /* Check if value is a multiline value */
        function is_multiline(val) {
            if ((typeof val) == 'string') {
                if(val.indexOf('\n') != -1) {
                    return true;
                }
            }
            return false;
        }

        /* Generate field id from base name and key */
        function field_id_from_key(base_name, key) {
            return base_name + '_' + key;
        }
        
        /* Get field by the table name and the key */
        function field_by_key(base_name, key) {
            return $('#' + field_id_from_key(base_name, key));
        }

        /* Generate table id from base_name */
        function table_id_from_name(base_name) {
            return base_name + '_table';
        }

        /* Get table by the base_name */
        function table_by_name(base_name) {
            return $('#' + table_id_from_name(base_name));
        }

        /* Set a value in a field and return the field */
        function set_value_in_field(field, value)
        {
            value = kunescape(value);
            if(is_multiline(value)) {
                field.append($('<pre>').text(value));
            }
            else {
                field.text(value);
            }
            return field;
        }
        /* Add a field to the table */
        function add_to_table(base_name, key, value) {
            if(key != 'sub_reports'){
                $('<tr>')
                .append(
                    $('<td>').text(toTitleCase(key)),
                    set_value_in_field($('<td class="textarea-data">'), value)
                )
                .appendTo(table_by_name(base_name));
            }
        }

        /* Set value of existing field in the table */
        function set_in_table(base_name, key, value) {
            set_value_in_field(field_by_key(base_name, key), value);
        }

        /* Fill a table from a report */
        function fill_table(base_name, report, first_fields) {
            var sub_reports = report.sub_reports;
            $.each(first_fields, function(idx, key){
                set_in_table(base_name, key, report[key]);
                delete report[key];
            });
            var keys = [];
            for (var prop in report) {
                keys.push(prop);
            }
            keys.sort();
            for (var i = 0; i < keys.length; i++) {
                var key = keys[i];
                var value = report[key];
                if(sub_reports.indexOf(key) == -1) {
                    add_to_table(base_name, key, value);
                }
            }
        }

        /* Create a table */
        function create_table(name, title) {
            var new_tr = $('<tr></tr>');
            new_tr.append(
                $('<td>').append(
                    $('<div>')
                    .append(
                        $('<div>')
                        .addClass('panel-heading')
                        .text(title)
                    )
                    .append(
                        $('<table>', {id:table_id_from_name(name)})
                        .addClass('table table-hover table-striped table-bordered info-table')
                        .append(
                            $('<tr>')
                            .append($('<td>').text('Issuer'))
                            .append($('<td>', {id: field_id_from_key(name, 'name')}))
                        ).append(
                            $('<tr>')
                            .append($('<td>').text('Status'))
                            .append($('<td>', {id: field_id_from_key(name, 'status')}))
                        ).append(
                            $('<tr>')
                            .append($('<td>').text('Reason'))
                            .append($('<td>', {id: field_id_from_key(name, 'reason')}))
                        )
                    )
                    .addClass('panel panel-danger')
                )
            ).appendTo($('#reports_container_table_body'));
        }

        /* Build tables and fill them for all reports */
        function build_tables(response) {
            var report = response.report;
            var sub_reports = report.sub_reports;
            $('#report_name').text('Report for test #' + report_num);
            fill_table('main_report', report, ['name', 'status', 'reason', 'fuzz_path']);
            sub_reports.sort();
            $.each(sub_reports, function(idx, key){
                subrep = report[key]
                create_table(sanitizeName(key), toTitleCase(key));
                fill_table(sanitizeName(key), subrep, ['name', 'status', 'reason']);
            });
        }

        /* Handle failure to fetch report */
        function handle_failure() {
            alert('Failed to load report');
        }

        /* dirty dirty dirty dirty */
        function get_report_num() {
            return document.URL.split('=').slice(-1)[0];
        }

        var report_num = get_report_num();
        document.title += ' #' + report_num;
        $.getJSON('../api/report?report_id=' + report_num, build_tables).fail(handle_failure);
    </script>
</body>
</html>